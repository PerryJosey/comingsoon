FSS={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"},FSS.Array="function"==typeof Float32Array?Float32Array:Array,FSS.Utils={isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}},function(){for(var n=0,t=["ms","moz","webkit","o"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var s=(new Date).getTime(),o=Math.max(0,16-(s-n)),i=window.setTimeout(function(){e(s+o)},o);return n=s+o,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Math.PIM2=2*Math.PI,Math.PID2=Math.PI/2,Math.randomInRange=function(e,t){return e+(t-e)*Math.random()},Math.clamp=function(e,t,n){return e=Math.max(e,t),e=Math.min(e,n)},FSS.Vector3={create:function(e,t,n){var s=new FSS.Array(3);return this.set(s,e,t,n),s},clone:function(e){var t=this.create();return this.copy(t,e),t},set:function(e,t,n,s){return e[0]=t||0,e[1]=n||0,e[2]=s||0,this},setX:function(e,t){return e[0]=t||0,this},setY:function(e,t){return e[1]=t||0,this},setZ:function(e,t){return e[2]=t||0,this},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],this},add:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],this},addVectors:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],this},addScalar:function(e,t){return e[0]+=t,e[1]+=t,e[2]+=t,this},subtract:function(e,t){return e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],this},subtractVectors:function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],this},subtractScalar:function(e,t){return e[0]-=t,e[1]-=t,e[2]-=t,this},multiply:function(e,t){return e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],this},multiplyVectors:function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],this},multiplyScalar:function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,this},divide:function(e,t){return e[0]/=t[0],e[1]/=t[1],e[2]/=t[2],this},divideVectors:function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],this},divideScalar:function(e,t){return 0!==t?(e[0]/=t,e[1]/=t,e[2]/=t):(e[0]=0,e[1]=0,e[2]=0),this},cross:function(e,t){var n=e[0],s=e[1],o=e[2];return e[0]=s*t[2]-o*t[1],e[1]=o*t[0]-n*t[2],e[2]=n*t[1]-s*t[0],this},crossVectors:function(e,t,n){return e[0]=t[1]*n[2]-t[2]*n[1],e[1]=t[2]*n[0]-t[0]*n[2],e[2]=t[0]*n[1]-t[1]*n[0],this},min:function(e,t){return e[0]<t&&(e[0]=t),e[1]<t&&(e[1]=t),e[2]<t&&(e[2]=t),this},max:function(e,t){return e[0]>t&&(e[0]=t),e[1]>t&&(e[1]=t),e[2]>t&&(e[2]=t),this},clamp:function(e,t,n){return this.min(e,t),this.max(e,n),this},limit:function(e,t,n){var s=this.length(e);return null!==t&&s<t?this.setLength(e,t):null!==n&&s>n&&this.setLength(e,n),this},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},normalise:function(e){return this.divideScalar(e,this.length(e))},negate:function(e){return this.multiplyScalar(e,-1)},distanceSquared:function(e,t){var n=e[0]-t[0],s=e[1]-t[1],o=e[2]-t[2];return n*n+s*s+o*o},distance:function(e,t){return Math.sqrt(this.distanceSquared(e,t))},lengthSquared:function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},length:function(e){return Math.sqrt(this.lengthSquared(e))},setLength:function(e,t){var n=this.length(e);return 0!==n&&t!==n&&this.multiplyScalar(e,t/n),this}},FSS.Vector4={create:function(e,t,n){var o=new FSS.Array(4);return this.set(o,e,t,n),o},set:function(e,t,n,s,o){return e[0]=t||0,e[1]=n||0,e[2]=s||0,e[3]=o||0,this},setX:function(e,t){return e[0]=t||0,this},setY:function(e,t){return e[1]=t||0,this},setZ:function(e,t){return e[2]=t||0,this},setW:function(e,t){return e[3]=t||0,this},add:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],this},multiplyVectors:function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],this},multiplyScalar:function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,this},min:function(e,t){return e[0]<t&&(e[0]=t),e[1]<t&&(e[1]=t),e[2]<t&&(e[2]=t),e[3]<t&&(e[3]=t),this},max:function(e,t){return e[0]>t&&(e[0]=t),e[1]>t&&(e[1]=t),e[2]>t&&(e[2]=t),e[3]>t&&(e[3]=t),this},clamp:function(e,t,n){return this.min(e,t),this.max(e,n),this}},FSS.Color=function(e,t){this.rgba=FSS.Vector4.create(),this.hex=e||"#000000",this.opacity=FSS.Utils.isNumber(t)?t:1,this.set(this.hex,this.opacity)},FSS.Color.prototype={set:function(e,t){var n=(e=e.replace("#","")).length/3;return this.rgba[0]=parseInt(e.substring(0*n,1*n),16)/255,this.rgba[1]=parseInt(e.substring(1*n,2*n),16)/255,this.rgba[2]=parseInt(e.substring(2*n,3*n),16)/255,this.rgba[3]=FSS.Utils.isNumber(t)?t:this.rgba[3],this},hexify:function(e){var t=Math.ceil(255*e).toString(16);return 1===t.length&&(t="0"+t),t},format:function(){var e=this.hexify(this.rgba[0]),t=this.hexify(this.rgba[1]),n=this.hexify(this.rgba[2]);return this.hex="#"+e+t+n,this.hex}},FSS.Object=function(){this.position=FSS.Vector3.create()},FSS.Object.prototype={setPosition:function(e,t,n){return FSS.Vector3.set(this.position,e,t,n),this}},FSS.Light=function(e,t){FSS.Object.call(this),this.ambient=new FSS.Color(e||"#FFFFFF"),this.diffuse=new FSS.Color(t||"#FFFFFF"),this.ray=FSS.Vector3.create()},FSS.Light.prototype=Object.create(FSS.Object.prototype),FSS.Vertex=function(e,t,n){this.position=FSS.Vector3.create(e,t,n)},FSS.Vertex.prototype={setPosition:function(e,t,n){return FSS.Vector3.set(this.position,e,t,n),this}},FSS.Triangle=function(e,t,n){this.a=e||new FSS.Vertex,this.b=t||new FSS.Vertex,this.c=n||new FSS.Vertex,this.vertices=[this.a,this.b,this.c],this.u=FSS.Vector3.create(),this.v=FSS.Vector3.create(),this.centroid=FSS.Vector3.create(),this.normal=FSS.Vector3.create(),this.color=new FSS.Color,this.polygon=document.createElementNS(FSS.SVGNS,"polygon"),this.polygon.setAttributeNS(null,"stroke-linejoin","round"),this.polygon.setAttributeNS(null,"stroke-miterlimit","1"),this.polygon.setAttributeNS(null,"stroke-width","1"),this.computeCentroid(),this.computeNormal()},FSS.Triangle.prototype={computeCentroid:function(){return this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0],this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1],this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2],FSS.Vector3.divideScalar(this.centroid,3),this},computeNormal:function(){return FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position),FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position),FSS.Vector3.crossVectors(this.normal,this.u,this.v),FSS.Vector3.normalise(this.normal),this}},FSS.Geometry=function(){this.vertices=[],this.triangles=[],this.dirty=!1},FSS.Geometry.prototype={update:function(){if(this.dirty){var e,t;for(e=this.triangles.length-1;e>=0;e--)(t=this.triangles[e]).computeCentroid(),t.computeNormal();this.dirty=!1}return this}},FSS.Plane=function(e,t,n,s){FSS.Geometry.call(this),this.width=e||100,this.height=t||100,this.segments=n||4,this.slices=s||4,this.segmentWidth=this.width/this.segments,this.sliceHeight=this.height/this.slices;var o,i,r,c,l,d,u,a=[],h=-.5*this.width,m=.5*this.height;for(o=0;o<=this.segments;o++)for(a.push([]),i=0;i<=this.slices;i++)l=new FSS.Vertex(h+o*this.segmentWidth,m-i*this.sliceHeight),a[o].push(l),this.vertices.push(l);for(o=0;o<this.segments;o++)for(i=0;i<this.slices;i++)d=a[o+0][i+0],r=a[o+0][i+1],c=a[o+1][i+0],u=a[o+1][i+1],t0=new FSS.Triangle(d,r,c),t1=new FSS.Triangle(c,r,u),this.triangles.push(t0,t1)},FSS.Plane.prototype=Object.create(FSS.Geometry.prototype),FSS.Material=function(e,t){this.ambient=new FSS.Color(e||"#444444"),this.diffuse=new FSS.Color(t||"#FFFFFF"),this.slave=new FSS.Color},FSS.Mesh=function(e,t){FSS.Object.call(this),this.geometry=e||new FSS.Geometry,this.material=t||new FSS.Material,this.side=FSS.FRONT,this.visible=!0},FSS.Mesh.prototype=Object.create(FSS.Object.prototype),FSS.Mesh.prototype.update=function(e,t){var n,s,o,i,a;if(this.geometry.update(),t)for(i=this.geometry.triangles.length-1;i>=0;i--){for(s=this.geometry.triangles[i],FSS.Vector4.set(s.color.rgba),a=e.length-1;a>=0;a--)o=e[a],FSS.Vector3.subtractVectors(o.ray,o.position,s.centroid),FSS.Vector3.normalise(o.ray),n=FSS.Vector3.dot(s.normal,o.ray),this.side===FSS.FRONT?n=Math.max(n,0):this.side===FSS.BACK?n=Math.abs(Math.min(n,0)):this.side===FSS.DOUBLE&&(n=Math.max(Math.abs(n),0)),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,o.ambient.rgba),FSS.Vector4.add(s.color.rgba,this.material.slave.rgba),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,o.diffuse.rgba),FSS.Vector4.multiplyScalar(this.material.slave.rgba,n),FSS.Vector4.add(s.color.rgba,this.material.slave.rgba);FSS.Vector4.clamp(s.color.rgba,0,1)}return this},FSS.Scene=function(){this.meshes=[],this.lights=[]},FSS.Scene.prototype={add:function(e){return e instanceof FSS.Mesh&&!~this.meshes.indexOf(e)?this.meshes.push(e):e instanceof FSS.Light&&!~this.lights.indexOf(e)&&this.lights.push(e),this},remove:function(e){return e instanceof FSS.Mesh&&~this.meshes.indexOf(e)?this.meshes.splice(this.meshes.indexOf(e),1):e instanceof FSS.Light&&~this.lights.indexOf(e)&&this.lights.splice(this.lights.indexOf(e),1),this}},FSS.Renderer=function(){this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0},FSS.Renderer.prototype={setSize:function(e,t){if(this.width!==e||this.height!==t)return this.width=e,this.height=t,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this},clear:function(){return this},render:function(){return this}},FSS.CanvasRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.context=this.element.getContext("2d"),this.setSize(this.element.width,this.element.height)},FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.CanvasRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.element.width=e,this.element.height=t,this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight),this},FSS.CanvasRenderer.prototype.clear=function(){return FSS.Renderer.prototype.clear.call(this),this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height),this},FSS.CanvasRenderer.prototype.render=function(e){var t,n,s,o,i;for(FSS.Renderer.prototype.render.call(this,e),this.clear(),this.context.lineJoin="round",this.context.lineWidth=1,n=e.meshes.length-1;n>=0;n--)if((s=e.meshes[n]).visible)for(s.update(e.lights,!0),o=s.geometry.triangles.length-1;o>=0;o--)i=(t=s.geometry.triangles[o]).color.format(),this.context.beginPath(),this.context.moveTo(t.a.position[0],t.a.position[1]),this.context.lineTo(t.b.position[0],t.b.position[1]),this.context.lineTo(t.c.position[0],t.c.position[1]),this.context.closePath(),this.context.strokeStyle=i,this.context.fillStyle=i,this.context.stroke(),this.context.fill();return this},FSS.WebGLRenderer=function(){if(FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.vertices=null,this.lights=null,this.gl=this.getContext(this.element,{preserveDrawingBuffer:!1,premultipliedAlpha:!0,antialias:!0,stencil:!0,alpha:!0}),this.unsupported=!this.gl,this.unsupported)return"WebGL is not supported by your browser.";this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.setSize(this.element.width,this.element.height)},FSS.WebGLRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.WebGLRenderer.prototype.getContext=function(e,t){var n=!1;try{if(!(n=e.getContext("experimental-webgl",t)))throw"Error creating WebGL context."}catch(e){console.error(e)}return n},FSS.WebGLRenderer.prototype.setSize=function(e,t){if(FSS.Renderer.prototype.setSize.call(this,e,t),!this.unsupported)return this.element.width=e,this.element.height=t,this.gl.viewport(0,0,e,t),this},FSS.WebGLRenderer.prototype.clear=function(){if(FSS.Renderer.prototype.clear.call(this),!this.unsupported)return this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this},FSS.WebGLRenderer.prototype.render=function(e){if(FSS.Renderer.prototype.render.call(this,e),!this.unsupported){var t,n,s,o,i,a,r,c,l,d,u,f,p,g,v,b=!1,h=e.lights.length,m=0;if(this.clear(),this.lights!==h){if(this.lights=h,!(this.lights>0))return;this.buildProgram(h)}if(this.program){for(o=e.meshes.length-1;o>=0;o--)(n=e.meshes[o]).geometry.dirty&&(b=!0),n.update(e.lights,!1),m+=3*n.geometry.triangles.length;if(b||this.vertices!==m)for(f in this.vertices=m,this.program.attributes){for((t=this.program.attributes[f]).data=new FSS.Array(m*t.size),s=0,o=e.meshes.length-1;o>=0;o--)for(d=0,g=(n=e.meshes[o]).geometry.triangles.length;d<g;d++)for(u=0,v=(r=n.geometry.triangles[d]).vertices.length;u<v;u++){switch(vertex=r.vertices[u],f){case"side":this.setBufferData(s,t,n.side);break;case"position":this.setBufferData(s,t,vertex.position);break;case"centroid":this.setBufferData(s,t,r.centroid);break;case"normal":this.setBufferData(s,t,r.normal);break;case"ambient":this.setBufferData(s,t,n.material.ambient.rgba);break;case"diffuse":this.setBufferData(s,t,n.material.diffuse.rgba)}s++}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t.data,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(t.location),this.gl.vertexAttribPointer(t.location,t.size,this.gl.FLOAT,!1,0,0)}for(this.setBufferData(0,this.program.uniforms.resolution,[this.width,this.height,this.width]),i=h-1;i>=0;i--)c=e.lights[i],this.setBufferData(i,this.program.uniforms.lightPosition,c.position),this.setBufferData(i,this.program.uniforms.lightAmbient,c.ambient.rgba),this.setBufferData(i,this.program.uniforms.lightDiffuse,c.diffuse.rgba);for(p in this.program.uniforms)switch(l=(t=this.program.uniforms[p]).location,a=t.data,t.structure){case"3f":this.gl.uniform3f(l,a[0],a[1],a[2]);break;case"3fv":this.gl.uniform3fv(l,a);break;case"4fv":this.gl.uniform4fv(l,a)}}return this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices),this}},FSS.WebGLRenderer.prototype.setBufferData=function(e,t,n){if(FSS.Utils.isNumber(n))t.data[e*t.size]=n;else for(var s=n.length-1;s>=0;s--)t.data[e*t.size+s]=n[s]},FSS.WebGLRenderer.prototype.buildProgram=function(e){if(!this.unsupported){var r,c,n=FSS.WebGLRenderer.VS(e),s=FSS.WebGLRenderer.FS(e),o=n+s;if(!this.program||this.program.code!==o){var t=this.gl.createProgram(),i=this.buildShader(this.gl.VERTEX_SHADER,n),a=this.buildShader(this.gl.FRAGMENT_SHADER,s);return this.gl.attachShader(t,i),this.gl.attachShader(t,a),this.gl.linkProgram(t),this.gl.getProgramParameter(t,this.gl.LINK_STATUS)?(this.gl.deleteShader(a),this.gl.deleteShader(i),t.code=o,t.attributes={side:this.buildBuffer(t,"attribute","aSide",1,"f"),position:this.buildBuffer(t,"attribute","aPosition",3,"v3"),centroid:this.buildBuffer(t,"attribute","aCentroid",3,"v3"),normal:this.buildBuffer(t,"attribute","aNormal",3,"v3"),ambient:this.buildBuffer(t,"attribute","aAmbient",4,"v4"),diffuse:this.buildBuffer(t,"attribute","aDiffuse",4,"v4")},t.uniforms={resolution:this.buildBuffer(t,"uniform","uResolution",3,"3f",1),lightPosition:this.buildBuffer(t,"uniform","uLightPosition",3,"3fv",e),lightAmbient:this.buildBuffer(t,"uniform","uLightAmbient",4,"4fv",e),lightDiffuse:this.buildBuffer(t,"uniform","uLightDiffuse",4,"4fv",e)},this.program=t,this.gl.useProgram(this.program),t):(r=this.gl.getError(),c=this.gl.getProgramParameter(t,this.gl.VALIDATE_STATUS),console.error(`Could not initialise shader.
VALIDATE_STATUS: `+c+`
ERROR: `+r),null)}}},FSS.WebGLRenderer.prototype.buildShader=function(e,t){if(!this.unsupported){var n=this.gl.createShader(e);return this.gl.shaderSource(n,t),this.gl.compileShader(n),this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)?n:(console.error(this.gl.getShaderInfoLog(n)),null)}},FSS.WebGLRenderer.prototype.buildBuffer=function(e,t,n,s,o,i){var a={buffer:this.gl.createBuffer(),size:s,structure:o,data:null};switch(t){case"attribute":a.location=this.gl.getAttribLocation(e,n);break;case"uniform":a.location=this.gl.getUniformLocation(e,n)}return i&&(a.data=new FSS.Array(i*s)),a},FSS.WebGLRenderer.VS=function(e){return["precision mediump float;","#define LIGHTS "+e,"attribute float aSide;","attribute vec3 aPosition;","attribute vec3 aCentroid;","attribute vec3 aNormal;","attribute vec4 aAmbient;","attribute vec4 aDiffuse;","uniform vec3 uResolution;","uniform vec3 uLightPosition[LIGHTS];","uniform vec4 uLightAmbient[LIGHTS];","uniform vec4 uLightDiffuse[LIGHTS];","varying vec4 vColor;","void main() {","vColor = vec4(0.0);","vec3 position = aPosition / uResolution * 2.0;","for (int i = 0; i < LIGHTS; i++) {","vec3 lightPosition = uLightPosition[i];","vec4 lightAmbient = uLightAmbient[i];","vec4 lightDiffuse = uLightDiffuse[i];","vec3 ray = normalize(lightPosition - aCentroid);","float illuminance = dot(aNormal, ray);","if (aSide == 0.0) {","illuminance = max(illuminance, 0.0);","} else if (aSide == 1.0) {","illuminance = abs(min(illuminance, 0.0));","} else if (aSide == 2.0) {","illuminance = max(abs(illuminance), 0.0);","}","vColor += aAmbient * lightAmbient;","vColor += aDiffuse * lightDiffuse * illuminance;","}","vColor = clamp(vColor, 0.0, 1.0);","gl_Position = vec4(position, 1.0);","}"].join(`
`)},FSS.WebGLRenderer.FS=function(){return["precision mediump float;","varying vec4 vColor;","void main() {","gl_FragColor = vColor;","}"].join(`
`)},FSS.SVGRenderer=function(){FSS.Renderer.call(this),this.element=document.createElementNS(FSS.SVGNS,"svg"),this.element.setAttribute("xmlns",FSS.SVGNS),this.element.setAttribute("version","1.1"),this.element.style.display="block",this.setSize(300,150)},FSS.SVGRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.SVGRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.element.setAttribute("width",e),this.element.setAttribute("height",t),this},FSS.SVGRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);for(var e=this.element.childNodes.length-1;e>=0;e--)this.element.removeChild(this.element.childNodes[e]);return this},FSS.SVGRenderer.prototype.render=function(e){var t,n,s,o,i,a;for(FSS.Renderer.prototype.render.call(this,e),n=e.meshes.length-1;n>=0;n--)if((s=e.meshes[n]).visible)for(s.update(e.lights,!0),o=s.geometry.triangles.length-1;o>=0;o--)(t=s.geometry.triangles[o]).polygon.parentNode!==this.element&&this.element.appendChild(t.polygon),i=this.formatPoint(t.a)+" ",i+=this.formatPoint(t.b)+" ",i+=this.formatPoint(t.c),a=this.formatStyle(t.color.format()),t.polygon.setAttributeNS(null,"points",i),t.polygon.setAttributeNS(null,"style",a);return this},FSS.SVGRenderer.prototype.formatPoint=function(e){return this.halfWidth+e.position[0]+","+(this.halfHeight-e.position[1])},FSS.SVGRenderer.prototype.formatStyle=function(e){var t="fill:"+e+";";return t+="stroke:"+e+";"},function(){var e,s,o,r,d,g,v,b,y,n={width:1.2,height:1.2,depth:10,segments:16,slices:8,xRange:.8,yRange:.1,zRange:3,ambient:"#444444",diffuse:"#FFFFFF",speed},t={count:2,xyScalar:1,zOffset:100,ambient:ambient_color,diffuse:diffuse_color,speed:.001,gravity:1200,dampening:.95,minLimit:10,maxLimit:null,minDistance:20,maxDistance:400,autopilot:!0,draw:!1,bounds:FSS.Vector3.create(),step:FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1))},E="webgl",l="canvas",_="svg",h={renderer:l},x=Date.now(),c=FSS.Vector3.create(),a=FSS.Vector3.create(),i=document.getElementById("effect-box"),j=(document.getElementById("controls"),document.getElementById("surface"));document.getElementById("ui");function u(){e.setSize(screen.availWidth,i.offsetHeight)}function w(t){switch(e&&j.removeChild(e.element),t){case E:e=b;break;case l:e=v;break;case _:e=g}e.setSize(i.offsetWidth,i.offsetHeight),j.appendChild(e.element)}function m(){var t,i;for(s.remove(d),e.clear(),o=new FSS.Plane(n.width*e.width,n.height*e.height,n.segments,n.slices),y=new FSS.Material(n.ambient,n.diffuse),d=new FSS.Mesh(o,y),s.add(d),t=o.vertices.length-1;t>=0;t--)(i=o.vertices[t]).anchor=FSS.Vector3.clone(i.position),i.step=FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1)),i.time=Math.randomInRange(0,Math.PIM2)}function O(){var n,o;for(o=s.lights.length-1;o>=0;o--)n=s.lights[o],s.remove(n);for(e.clear(),o=0;o<t.count;o++)(n=new FSS.Light(t.ambient,t.diffuse)).ambientHex=n.ambient.format(),n.diffuseHex=n.diffuse.format(),s.add(n),n.mass=Math.randomInRange(.5,1),n.velocity=FSS.Vector3.create(),n.acceleration=FSS.Vector3.create(),n.force=FSS.Vector3.create(),n.ring=document.createElementNS(FSS.SVGNS,"circle"),n.ring.setAttributeNS(null,"stroke",n.ambientHex),n.ring.setAttributeNS(null,"stroke-width","0.5"),n.ring.setAttributeNS(null,"fill","none"),n.ring.setAttributeNS(null,"r","10"),n.core=document.createElementNS(FSS.SVGNS,"circle"),n.core.setAttributeNS(null,"fill",n.diffuseHex),n.core.setAttributeNS(null,"r","4")}function u(t,n){e.setSize(t,n),FSS.Vector3.set(c,e.halfWidth,e.halfHeight),m()}function p(){r=Date.now()-x,C(),f(),requestAnimationFrame(p)}function C(){m=n.depth/2;for(FSS.Vector3.copy(t.bounds,c),FSS.Vector3.multiplyScalar(t.bounds,t.xyScalar),FSS.Vector3.setZ(a,t.zOffset),t.autopilot&&(l=Math.sin(t.step[0]*r*t.speed),d=Math.cos(t.step[1]*r*t.speed),FSS.Vector3.set(a,t.bounds[0]*l,t.bounds[1]*d,t.zOffset)),u=s.lights.length-1;u>=0;u--){e=s.lights[u],FSS.Vector3.setZ(e.position,t.zOffset);var e,i,l,d,u,h,m,f,p=Math.clamp(FSS.Vector3.distanceSquared(e.position,a),t.minDistance,t.maxDistance),g=t.gravity*e.mass/p;FSS.Vector3.subtractVectors(e.force,a,e.position),FSS.Vector3.normalise(e.force),FSS.Vector3.multiplyScalar(e.force,g),FSS.Vector3.set(e.acceleration),FSS.Vector3.add(e.acceleration,e.force),FSS.Vector3.add(e.velocity,e.acceleration),FSS.Vector3.multiplyScalar(e.velocity,t.dampening),FSS.Vector3.limit(e.velocity,t.minLimit,t.maxLimit),FSS.Vector3.add(e.position,e.velocity)}for(h=o.vertices.length-1;h>=0;h--)i=o.vertices[h],l=Math.sin(i.time+i.step[0]*r*n.speed),d=Math.cos(i.time+i.step[1]*r*n.speed),f=Math.sin(i.time+i.step[2]*r*n.speed),FSS.Vector3.set(i.position,n.xRange*o.segmentWidth*l,n.yRange*o.sliceHeight*d,n.zRange*m*f-m),FSS.Vector3.add(i.position,i.anchor);o.dirty=!0}function f(){var n,o,i,a;if(e.render(s),t.draw)for(a=s.lights.length-1;a>=0;a--)switch(i=(n=s.lights[a]).position[0],o=n.position[1],h.renderer){case l:e.context.lineWidth=.5,e.context.beginPath(),e.context.arc(i,o,10,0,Math.PIM2),e.context.strokeStyle=n.ambientHex,e.context.stroke(),e.context.beginPath(),e.context.arc(i,o,4,0,Math.PIM2),e.context.fillStyle=n.diffuseHex,e.context.fill();break;case _:i+=e.halfWidth,o=e.halfHeight-o,n.core.setAttributeNS(null,"fill",n.diffuseHex),n.core.setAttributeNS(null,"cx",i),n.core.setAttributeNS(null,"cy",o),e.element.appendChild(n.core),n.ring.setAttributeNS(null,"stroke",n.ambientHex),n.ring.setAttributeNS(null,"cx",i),n.ring.setAttributeNS(null,"cy",o),e.element.appendChild(n.ring)}}function k(n){FSS.Vector3.set(a,n.x,e.height-n.y),FSS.Vector3.subtract(a,c),t.autopilot=!t.autopilot}function A(t){FSS.Vector3.set(a,t.x,e.height-t.y),FSS.Vector3.subtract(a,c)}function S(){u(i.offsetWidth,i.offsetHeight),f()}b=new FSS.WebGLRenderer,v=new FSS.CanvasRenderer,g=new FSS.SVGRenderer,w(h.renderer),s=new FSS.Scene,m(),O(),window.addEventListener("resize",S),i.addEventListener("click",k),i.addEventListener("mousemove",A),u(i.offsetWidth,i.offsetHeight),p()}()